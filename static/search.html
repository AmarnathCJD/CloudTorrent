<!DOCTYPE html>
<html>

<head>
    <meta name="og:title" content="Search" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="utf-8" />
    <meta name="description" content="" />
    <link rel="stylesheet" href="/static/css/style.css" />
    <link rel="stylesheet" href="/static/css/dark.css" />
</head>

<body>
    <div class="container d-flex p-3 mx-auto w-100 flex-column">
        <header class="mb-auto">
            <div class="float-md-start fw-bold fs-5">
                <h1>
                    <i class="bi bi-cloud-download" style="color: cornflowerblue"></i>
                    Cloud Torrent
                </h1>
            </div>
            <nav class="nav justify-content-center float-md-end">
                <a class="nav-item nav-link active" href="/"><button class="btn btn-primary navbar-btn">
                        Home <i class="bi bi-house"></i></button></a>
                <a class="nav-link" href="/downloads"><button class="btn btn-primary">
                        Files <i class="bi bi-list-ul"></i></button></a>
                <a class="nav-link" href="/search/" target="_blank"><button class="btn btn-danger active">
                        Search <i class="bi bi-search"></i></button></a>
                <div class="nav-link">
                    <div class="form-check form-switch">
                        <input type="checkbox" class="form-check-input" id="darkSwitch" />
                        <label class="custom-control-label" for="darkSwitch" id="dark-icon"><i
                                class="bi bi-brightness-high"></i></label>
                    </div>
                </div>
            </nav>
        </header>
        <div class="align-self-end" style="margin-top: 20px;">
            <div class="input-group">
                <div class="form-outline" id="search-bar">
                    <input id="search-input" type="search" id="form1" class="form-control dropdown-toggle show"
                        aria-label="Search" placeholder="Type query" data-provide="typeahead" />
                </div>
                <button id="search-button" type="button" class="btn btn-primary" onclick="FetchTorrents()">
                    <i class="bi bi-search"></i>
                </button>
            </div>
        </div>
        <main>
            <div class="table-responsive">
                <table id="files-table" class="table caption-top primary"></table>
            </div>
        </main>
    </div>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-3-typeahead/4.0.2/bootstrap3-typeahead.min.js">
    </script>
    <script>
        var darkSwitch = document.getElementById("darkSwitch");
        var DarkIcon = document.getElementById("dark-icon");
        var table = document.getElementById("files-table");
        var searchBox = document.getElementById("search-bar");

        const DEFAULTS = {
            treshold: 2,
            maximumItems: 5,
            highlightTyped: true,
            highlightClass: 'text-primary',
        };

        class Autocomplete {
            constructor(field, options) {
                this.field = field;
                this.options = Object.assign({}, DEFAULTS, options);
                this.dropdown = null;

                field.parentNode.classList.add('dropdown');
                field.setAttribute('data-toggle', 'dropdown');
                field.classList.add('dropdown-toggle');

                const dropdown = ce(`<div id="drop-down" class="dropdown-menu" ></div>`);
                if (this.options.dropdownClass)
                    dropdown.classList.add(this.options.dropdownClass);

                insertAfter(dropdown, field);

                this.dropdown = new bootstrap.Dropdown(field, this.options.dropdownOptions)

                field.addEventListener('click', (e) => {
                    if (this.createItems() === 0) {
                        e.stopPropagation();
                        this.dropdown.hide();
                    }
                });

                field.addEventListener('input', () => {
                    if (this.options.onInput)
                        this.options.onInput(this.field.value);
                    this.renderIfNeeded();
                });

                field.addEventListener('keydown', (e) => {
                    if (e.keyCode === 27) {
                        this.dropdown.hide();
                        return;
                    }
                });
            }

            setData(data) {
                this.options.data = data;
            }

            renderIfNeeded() {
                if (this.createItems() > 0)
                    this.dropdown.show();
                else
                    this.field.click();
            }

            createItem(lookup, item) {
                let label;
                if (this.options.highlightTyped) {
                    const idx = item.label.toLowerCase().indexOf(lookup.toLowerCase());
                    const className = Array.isArray(this.options.highlightClass) ? this.options.highlightClass.join(' ')
                        : (typeof this.options.highlightClass == 'string' ? this.options.highlightClass : '')
                    label = item.label.substring(0, idx)
                        + `<span class="${className}">${item.label.substring(idx, idx + lookup.length)}</span>`
                        + item.label.substring(idx + lookup.length, item.label.length);
                } else
                    label = item.label;
                return ce(`<button type="button" class="dropdown-item" data-value="${item.value}">${label}</button>`);
            }

            createItems() {
                const lookup = this.field.value;
                if (lookup.length < this.options.treshold) {
                    this.dropdown.hide();
                    return 0;
                }

                const items = this.field.nextSibling;
                items.innerHTML = '';

                let count = 0;
                for (let i = 0; i < this.options.data.length; i++) {
                    const { label, value } = this.options.data[i];
                    const item = { label, value };
                    if (item.label.toLowerCase().indexOf(lookup.toLowerCase()) >= 0) {
                        items.appendChild(this.createItem(lookup, item));
                        if (this.options.maximumItems > 0 && ++count >= this.options.maximumItems)
                            break;
                    }
                }

                this.field.nextSibling.querySelectorAll('.dropdown-item').forEach((item) => {
                    item.addEventListener('click', (e) => {
                        let dataValue = e.target.getAttribute('data-value');
                        this.field.value = e.target.innerText;
                        if (this.options.onSelectItem)
                            this.options.onSelectItem({
                                value: e.target.value,
                                label: e.target.innerText,
                            });
                        this.dropdown.hide();
                    })
                });

                return items.childNodes.length;
            }
        }

        function ce(html) {
            let div = document.createElement('div');
            div.innerHTML = html;
            return div.firstChild;
        }

        function insertAfter(elem, refElem) {
            return refElem.parentNode.insertBefore(elem, refElem.nextSibling)
        }

        window.addEventListener("load", function () {
            if (darkSwitch) {
                initTheme();
                darkSwitch.addEventListener("change", function () {
                    resetTheme();
                });
            }
        });
        function initTheme() {
            var darkThemeSelected =
                localStorage.getItem("darkSwitch") !== null &&
                localStorage.getItem("darkSwitch") === "dark";
            darkSwitch.checked = darkThemeSelected;
            darkThemeSelected
                ? document.body.setAttribute("data-theme", "dark")
                : document.body.removeAttribute("data-theme");
            if (darkThemeSelected) {
                DarkIcon.innerHTML = '<i class="bi bi-moon-stars-fill"></i>';
                table.classList.add("table-dark");
                DarkDropDown(true)
            } else {
                DarkIcon.innerHTML = "&#x2600;";
                table.classList.remove("table-dark");
                DarkDropDown(false)
            }
        }
        function resetTheme() {
            if (darkSwitch.checked) {
                document.body.setAttribute("data-theme", "dark");
                localStorage.setItem("darkSwitch", "dark");
                DarkIcon.innerHTML = '<i class="bi bi-moon-stars-fill"></i>';
                table.classList.add("table-dark");
                DarkDropDown(true)
            } else {
                document.body.removeAttribute("data-theme");
                localStorage.removeItem("darkSwitch");
                DarkIcon.innerHTML = "&#x2600;";
                table.classList.remove("table-dark");
                DarkDropDown(false)
            }
        }
        var Input = document.getElementById("search-input");
        Input.addEventListener("keyup", function (event) {
            var val = Input.value;
            if (val.split("").length > 2) {
                $.ajax({
                    url: "/api/autocomplete?q=" + val,
                    type: "GET",
                    success: function (data) {
                        var match = JSON.parse(data);
                        var data = []
                        for (var i = 0; i < match.length; i++) {
                            data.push({
                                label: match[i].substring(0, 22),
                                value: i
                            });
                        }
                        ac.setData(data);
                    }
                });
            }
        });

        const ac = new Autocomplete(document.getElementById("search-input"));
        ac.setData([]);

        function DarkDropDown(mode) {
            var DropDown = document.getElementById("drop-down");
            if (DropDown !== null) {
                if (mode) {
                    DropDown.classList.add("dropdown-menu-dark");
                } else {
                    DropDown.classList.remove("dropdown-menu-dark");
                }
            }
        }

        function FetchTorrents() {
            var Query = Input.value;
            var url = `/api/search?q=` + Query;
            var querytype = "Search results for: " + Query;
            if (Query == "") {
                url = `/api/search?q=top100`;
                querytype = "Top Trending"
            }
            $.ajax({
                url: url,
                type: "GET",
                dataType: "json",
                success: function (data) {
                    var table = $("#files-table");
                    table.empty();
                    table.append(
                        "<caption>" + querytype + "</caption><tr><th style='width: 3.66%'>ID</th><th>Name</th><th>Size</th><th>Seeds</th><th>Peers</th><th>Actions</th></tr>"
                    );
                    for (var i = 0; i < data.length; i++) {
                        var file = data[i];
                        var row = $("<tr></tr>");
                        var num = i + 1;
                        row.append("<td>" + num + "</td>");
                        row.append("<td>" + file.name.substring(0, 52) + "..." + "</td>");
                        row.append("<td>" + file.size + "</td>");
                        row.append("<td>" + file.seeders + "</td>");
                        row.append("<td>" + file.leechers + "</td>");
                        row.append(
                            "<td><div class='btn-group'><a href='/torrents/add?uid=" +
                            file.info_hash +
                            "' class='btn btn-primary'><i class='bi bi-download'></i></a><a href='/torrents/add?uid=" +
                            file.info_hash +
                            "' class='btn btn-danger'><i class='bi bi-plus-square'></i></i></a></div></td>"
                        );
                        table.append(row);
                        if (i == 24) {
                            break;
                        }
                    }
                }
            })
        }
        FetchTorrents();
    </script>
</body>

</html>