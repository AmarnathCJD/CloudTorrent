<!DOCTYPE html>
<html>

<head>
    <meta name="og:title" content="Search" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="utf-8" />
    <meta name="description" content="" />
    <meta name="viewport" content="width=device-width, user-scalable=yes, initial-scale=1, user-scalable=1" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5/dist/css/bootstrap.min.css">
    <style>
        @import url("https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css");
        @import url("https://cdn.jsdelivr.net/npm/bootstrap@5/dist/css/bootstrap.min.css");

        [data-theme="dark"] {
            background-color: #111 !important;
            color: #eee;
        }

        [data-theme="dark"] .bg-black {
            background-color: #fff !important;
        }

        [data-theme="dark"] .bg-dark {
            background-color: #eee !important;
        }

        [data-theme="dark"] .bg-light {
            background-color: #222 !important;
        }

        [data-theme="dark"] .bg-white {
            background-color: #000 !important;
        }
    </style>
</head>

<body>
    <div class="container d-flex p-3 mx-auto w-100 flex-column">
        <header class="mb-auto">
            <div class="float-md-start fw-bold fs-5">
                <h1>
                    <i class="bi bi-cloud-download" style="color: cornflowerblue"></i>
                    Cloud Torrent
                </h1>
            </div>
            <nav class="nav justify-content-center float-md-end">
                <a class="nav-item nav-link active" href="/"><button class="btn btn-primary navbar-btn">
                        Home <i class="bi bi-house"></i></button></a>
                <a class="nav-link" href="/downloads"><button class="btn btn-primary">
                        Files <i class="bi bi-list-ul"></i></button></a>
                <a class="nav-link" href="/search?query=top100" target="_blank"><button class="btn btn-danger active">
                        Search <i class="bi bi-search"></i></button></a>
                <div class="nav-link">
                    <div class="form-check form-switch">
                        <input type="checkbox" class="form-check-input" id="darkSwitch" />
                        <label class="custom-control-label" for="darkSwitch" id="dark-icon"><i
                                class="bi bi-brightness-high"></i></label>
                    </div>
                </div>
            </nav>
        </header>
        <div class="align-self-end" style="margin-top: 20px;">
            <div class="input-group">
                <div class="form-outline" id="search-bar">
                    <input id="search-input" type="search" id="form1" class="form-control" aria-label="Search"
                        placeholder="Type query" />
                </div>
                <button id="search-button" type="button" class="btn btn-primary" onclick="Search()">
                    <i class="bi bi-search"></i>
                </button>
            </div>
            <ul class="list-group list-group-numbered" id="search-results" style="margin-top: 5px;">
            </ul>
        </div>
        <main>
            <div class="table-responsive">
                <table id="files-table" class="table caption-top primary"></table>
            </div>
        </main>
    </div>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>
    <script>
        var darkSwitch = document.getElementById("darkSwitch");
        var DarkIcon = document.getElementById("dark-icon");
        var table = document.getElementById("files-table");
        var searchBox = document.getElementById("search-bar");
        window.addEventListener("load", function () {
            if (darkSwitch) {
                initTheme();
                darkSwitch.addEventListener("change", function () {
                    resetTheme();
                });
            }
        });
        function initTheme() {
            var darkThemeSelected =
                localStorage.getItem("darkSwitch") !== null &&
                localStorage.getItem("darkSwitch") === "dark";
            darkSwitch.checked = darkThemeSelected;
            darkThemeSelected
                ? document.body.setAttribute("data-theme", "dark")
                : document.body.removeAttribute("data-theme");
            if (darkThemeSelected) {
                DarkIcon.innerHTML = '<i class="bi bi-moon-stars-fill"></i>';
                table.classList.add("table-dark");
            } else {
                DarkIcon.innerHTML = "&#x2600;";
                table.classList.remove("table-dark");
            }
        }
        function resetTheme() {
            if (darkSwitch.checked) {
                document.body.setAttribute("data-theme", "dark");
                localStorage.setItem("darkSwitch", "dark");
                DarkIcon.innerHTML = '<i class="bi bi-moon-stars-fill"></i>';
                AutoCompleteDark(true);
                table.classList.add("table-dark");
            } else {
                document.body.removeAttribute("data-theme");
                localStorage.removeItem("darkSwitch");
                DarkIcon.innerHTML = "&#x2600;";
                AutoCompleteDark(false);
                table.classList.remove("table-dark");
            }
        }

        function AutoCompleteDark(o) {
            if (o) {
                var col = document.getElementsByClassName("list-group-item");
                for (var i = 0; i < col.length; i++) {
                    col[i].style.backgroundColor = "#222";
                    col[i].style.color = "#eee";
                }
            } else {
                var col = document.getElementsByClassName("list-group-item");
                for (var i = 0; i < col.length; i++) {
                    col[i].style.backgroundColor = "#eee";
                    col[i].style.color = "#000";
                }
            }
        }
        var search = document.getElementById("search-bar");
        function RemYear(s) {
            var year = s.split("(");
            return year[0];
        }
        var Input = document.getElementById("search-input");
        Input.addEventListener("keyup", function (event) {
            var val = Input.value;
            if (event.keyCode === 8) {
                document.getElementById("search-results").innerHTML = "";
                return;
            }
            if (val.split("").length > 3 && val.split("").length % 2 == 0) {
                $.ajax({
                    url: "/api/autocomplete?q=" + val,
                    type: "GET",
                    success: function (data) {
                        var match = JSON.parse(data);
                        var results = document.getElementById("search-results");
                        results.innerHTML = "";
                        for (var i = 0; i < match.length; i++) {
                            var li = results.appendChild(document.createElement("li"));
                            var name = match[i].substring(0, 22) + "..."
                            li.className = "list-group-item";
                            li.id = "result-" + i;
                            li.data = match[i];
                            li.onclick = function (e) {
                                document.getElementById("search-input").value = RemYear(this.data);
                                document.getElementById(this.id).classList.add("active");
                                var col = document.getElementsByClassName("list-group-item");
                                for (var i = 0; i < col.length; i++) {
                                    if (col[i].id != this.id) {
                                        col[i].classList.remove("active");
                                    }
                                }
                            }
                            li.innerHTML = name;
                            results.appendChild(li);
                            if (i == 5) {
                                break;
                            }
                        }
                        if (darkSwitch.checked) {
                            AutoCompleteDark(true);
                        }
                    },
                });
            }
        });
        $(document).on("click", function (e) {
            if (!$(e.target).closest("#search-input").length) {
                document.getElementById("search-results").innerHTML = "";
            }
        });
        function FetchTopTorrents() {
            $.ajax({
                url: "/api/search?q=top100",
                type: "GET",
                dataType: "json",
                success: function (data) {
                    var table = $("#files-table");
                    table.empty();
                    table.append(
                        "<caption>Top Trending</caption><tr><th style='width: 3.66%'>ID</th><th>Name</th><th>Size</th><th>Seeds/Peers</th><th >Actions</th></tr>"
                    );
                    for (var i = 0; i < data.length; i++) {
                        var file = data[i];
                        var row = $("<tr></tr>");
                        var num = i + 1;
                        row.append("<td>" + num + "</td>");
                        row.append("<td>" + file.name + "</td>");
                        row.append("<td>" + file.size + "</td>");
                        row.append("<td>" + file.seeders + "/" + file.leechers + "</td>");
                        row.append(
                            "<td><a href='/torrents/add?uid=" +
                            file.info_hash +
                            "' class='btn btn-primary'><i class='bi bi-download'></i> Download</a></td>"
                        );
                        table.append(row);
                        if (i == 24) {
                            break;
                        }
                    }
                },
            });
        }

        function Search() {
            var val = document.getElementById("search-input").value;
            $.ajax({
                url: "/api/search?q=" + val,
                type: "GET",
                dataType: "json",
                success: function (data) {
                    var table = $("#files-table");
                    table.empty();
                    table.append(
                        "<caption>Search results for " + val + "</caption><tr><th style='width: 3.66%'>ID</th><th>Name</th><th>Size</th><th>Seeds/Peers</th><th >Actions</th></tr>"
                    );
                    for (var i = 0; i < data.length; i++) {
                        var file = data[i];
                        var row = $("<tr></tr>");
                        var num = i + 1;
                        row.append("<td>" + num + "</td>");
                        row.append("<td>" + file.name + "</td>");
                        row.append("<td>" + file.size + "</td>");
                        row.append("<td>" + file.seeders + "/" + file.leechers + "</td>");
                        row.append(
                            "<td><a href='/torrents/add?uid=" +
                            file.info_hash +
                            "' class='btn btn-primary'><i class='bi bi-download'></i> Download</a></td>"
                        );
                        table.append(row);
                        if (i == 24) {
                            break;
                        }
                    }
                }
            });
        }
        FetchTopTorrents();
    </script>
</body>

</html>